package jenkins

import (
	jsoniter "github.com/json-iterator/go"
	"github.com/stretchr/testify/assert"
	"testing"
	"time"
)

func TestEnrichItem(t *testing.T) {
	type fields struct {
		DSName                string
		ElasticSearchProvider ESClientProvider
		BackendVersion        string
	}
	type args struct {
		rawItem BuildsRaw
		project string
		now     time.Time
	}
	rawItem1String := `{"backend_name":"jenkins","backend_version":"0.1.0","perceval_version":"","timestamp":0,"origin":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger","uuid":"1877de1a2694b58e8b7de9a586b99b7de1039fa8","updated_on":1557215745.02,"classified_fields_filtered":null,"category":"build","search_fields":{"item_id":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger/job/1.0.0/2/","number":2},"tag":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger","data":{"_class":"org.jenkinsci.plugins.workflow.job.WorkflowRun","actions":[{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"hudson.model.CauseAction","causes":[{"_class":"hudson.model.Cause$UserIdCause","shortDescription":"Started by user Bulat Saifullin"},{"_class":"org.jenkinsci.plugins.workflow.cps.replay.ReplayCause","shortDescription":"Replayed #1"}],"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"jenkins.scm.api.SCMRevisionAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"hudson.model.ParametersAction","parameters":[{"_class":"hudson.model.StringParameterValue","name":"build_scenario","value":"Default"},{"_class":"hudson.model.StringParameterValue","name":"custom_cmd","value":""}],"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"jenkins.scm.api.SCMRevisionAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"hudson.plugins.git.GitTagAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"org.jenkinsci.plugins.workflow.cps.EnvActionImpl","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"hudson.tasks.junit.TestResultAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"org.jenkinsci.plugins.displayurlapi.actions.RunDisplayAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"org.jenkinsci.plugins.pipeline.modeldefinition.actions.RestartDeclarativePipelineAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"_class":"org.jenkinsci.plugins.workflow.job.views.FlowGraphAction","buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}},{"buildsByBranchName":{"refs/remotes/origin/master":{"_class":"","buildNumber":0,"buildResult":null,"marked":{"SHA1":"","branch":null},"revision":{"SHA1":"","branch":null}}},"lastBuiltRevision":{"SHA1":"","branch":null}}],"artifacts":[],"building":false,"description":null,"displayName":"#2","duration":1343151,"estimatedDuration":1081333,"executor":null,"fullDisplayName":"iroha » iroha-hyperledger » 1.0.0 #2","id":"2","keepLog":false,"number":2,"queueId":404128,"result":"SUCCESS","timestamp":1557215745020,"url":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger/job/1.0.0/2/","builtOn":"","changeSet":{"_class":"","items":null,"kind":""},"culprits":[],"runs":null},"metadata__updated_on":"2020-12-23T18:38:27.258118608+05:30","metadata__timestamp":"2020-12-23T18:38:27.258118696+05:30"}`
	jenkinsRaw1, _ := toJenkinsRaw(rawItem1String)
	enrichItem1String := `{"project_ts":1557215745020,"metadata__updated_on":"2020-12-23T18:38:27.258118608+05:30","metadata__timestamp":"2020-12-23T18:38:27.258118696+05:30","offset":null,"origin":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger","tag":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger","uuid":"1877de1a2694b58e8b7de9a586b99b7de1039fa8","fullDisplayName":"iroha » iroha-hyperledger » 1.0.0 #2","url":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger/job/1.0.0/2/","result":"SUCCESS","duration":1343151,"builtOn":"main","fullDisplayName_analyzed":"iroha » iroha-hyperledger » 1.0.0 #2","build":2,"job_url":"https://jenkins.soramitsu.co.jp/job/iroha/job/iroha-hyperledger/job/1.0.0","job_name":"1.0.0","job_build":"#2/2","build_date":"2019-05-07T13:25:45.02+05:30","duration_days":0.015545729166666666,"category":"build","installer":"","scenario":null,"testproject":"","pod":"","loop":"","branch":"","grimoire_creation_date":"2019-05-07T13:25:45.02+05:30","is_jenkins_job":1,"repository_labels":null,"metadata__filter_raw":null,"metadata__gelk_version":"","metadata__gelk_backend_name":"","metadata__enriched_on":"2020-12-23T20:17:25.932147394+05:30"}`
	jenkinsEnrich1, _ := toJenkinsEnrich(enrichItem1String)
	rawItem2String := `{"timestamp":1581724923.6102,"backend_name":"Jenkins","tag":"https://jenkins.edgexfoundry.org","search_fields":{"number":80,"item_id":"https://jenkins.edgexfoundry.org/job/device-random-fuji-stage-go/80/"},"category":"build","uuid":"1270cb24e2b66e408413179d83990ca6458de63d","perceval_version":"0.12.26","classified_fields_filtered":null,"metadata__updated_on":"2020-01-16T00:44:56.258000+00:00","metadata__timestamp":"2020-02-15T00:02:03.610200+00:00","origin":"https://jenkins.edgexfoundry.org","data":{"builtOn":"prd-centos7-docker-4c-2g-14651","executor":null,"actions":[{"causes":[{"shortDescription":"Started by timer","_class":"hudson.triggers.TimerTrigger$TimerTriggerCause"}],"_class":"hudson.model.CauseAction"},{"parameters":[{"name":"PROJECT","_class":"hudson.model.StringParameterValue","value":"device-random"},{"name":"STREAM","_class":"hudson.model.StringParameterValue","value":"fuji"},{"name":"GERRIT_PROJECT","_class":"hudson.model.StringParameterValue","value":"device-random"},{"name":"GERRIT_BRANCH","_class":"hudson.model.StringParameterValue","value":"fuji"},{"name":"GERRIT_REFSPEC","_class":"hudson.model.StringParameterValue","value":"refs/heads/fuji"},{"name":"sha1","_class":"hudson.model.StringParameterValue","value":"origin/fuji"}],"_class":"hudson.model.ParametersAction"},{},{},{"scmName":"","lastBuiltRevision":{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","branch":[{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","name":"refs/remotes/origin/fuji"}]},"remoteUrls":["git@github.com:edgexfoundry/device-random"],"_class":"hudson.plugins.git.util.BuildData","buildsByBranchName":{"refs/remotes/origin/fuji":{"marked":{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","branch":[{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","name":"refs/remotes/origin/fuji"}]},"buildResult":null,"_class":"hudson.plugins.git.util.Build","revision":{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","branch":[{"SHA1":"632a155c8fb68d204d9b95ad3c38ca6d19298346","name":"refs/remotes/origin/fuji"}]},"buildNumber":80}}},{"_class":"hudson.plugins.git.GitTagAction"},{},{},{},{},{},{"parameters":[],"_class":"hudson.model.ParametersAction"},{},{},{},{}],"number":80,"timestamp":1579135496258,"changeSet":{"kind":"git","_class":"hudson.plugins.git.GitChangeSetList","items":[]},"building":false,"displayName":"#80","id":"80","estimatedDuration":168354,"fullDisplayName":"device-random-fuji-stage-go #80","description":"Build logs: <a href=\"https://logs.edgexfoundry.org/production/vex-yul-edgex-jenkins-1/device-random-fuji-stage-go/80","duration":160706,"_class":"hudson.model.FreeStyleBuild","artifacts":[],"culprits":[],"keepLog":false,"url":"https://jenkins.edgexfoundry.org/job/device-random-fuji-stage-go/80/","queueId":162780,"result":"SUCCESS"},"updated_on":1579135496.258,"backend_version":"0.15.1"}`
	jenkinsRaw2, _ := toJenkinsRaw(rawItem2String)
	enrichItem2String := `{"project_ts":1579135496258,"metadata__updated_on":"2020-01-16T00:44:56.258Z","metadata__timestamp":"2020-02-15T00:02:03.6102Z","offset":null,"origin":"https://jenkins.edgexfoundry.org","tag":"https://jenkins.edgexfoundry.org","uuid":"1270cb24e2b66e408413179d83990ca6458de63d","fullDisplayName":"device-random-fuji-stage-go #80","url":"https://jenkins.edgexfoundry.org/job/device-random-fuji-stage-go/80/","result":"SUCCESS","duration":160706,"builtOn":"prd-centos7-docker-4c-2g-14651","fullDisplayName_analyzed":"device-random-fuji-stage-go #80","build":80,"job_url":"https://jenkins.edgexfoundry.org/job/device-random-fuji-stage-go","job_name":"device-random-fuji-stage-go","job_build":"#80/80","build_date":"2020-01-16T06:14:56.258+05:30","duration_days":0.0018600231481481482,"category":"test","installer":"random","scenario":null,"testproject":"device","pod":"fuji","loop":"stage","branch":"go","grimoire_creation_date":"2020-01-16T06:14:56.258+05:30","is_jenkins_job":1,"repository_labels":null,"metadata__filter_raw":null,"metadata__gelk_version":"","metadata__gelk_backend_name":"","metadata__enriched_on":"2020-12-23T20:29:05.307544467+05:30"}`
	jenkinsEnrich2, _ := toJenkinsEnrich(enrichItem2String)
	rawItem3String := `{"timestamp":1581724932.025811,"backend_name":"Jenkins","tag":"https://jenkins.edgexfoundry.org","search_fields":{"number":85,"item_id":"https://jenkins.edgexfoundry.org/job/edgex-docs-master-verify-docs/85/"},"category":"build","uuid":"609b30e8ed96ac57cb55dc0a87934f2c20460c43","perceval_version":"0.12.26","classified_fields_filtered":null,"metadata__updated_on":"2020-01-16T04:09:17.248000+00:00","metadata__timestamp":"2020-02-15T00:02:12.025811+00:00","origin":"https://jenkins.edgexfoundry.org","data":{"builtOn":"prd-centos7-docker-4c-2g-14669","executor":null,"actions":[{"causes":[{"shortDescription":"GitHub pull request #78 of commit d473f9c0f47640010417392815fc25e8f4344c25, no merge conflicts.","_class":"org.jenkinsci.plugins.ghprb.GhprbCause"}],"_class":"hudson.model.CauseAction"},{"parameters":[{"name":"PROJECT","_class":"hudson.model.StringParameterValue","value":"edgex-docs"},{"name":"STREAM","_class":"hudson.model.StringParameterValue","value":"master"},{"name":"GERRIT_PROJECT","_class":"hudson.model.StringParameterValue","value":"edgex-docs"},{"name":"GERRIT_BRANCH","_class":"hudson.model.StringParameterValue","value":"master"},{"name":"GERRIT_REFSPEC","_class":"hudson.model.StringParameterValue","value":"refs/heads/master"},{"name":"sha1","_class":"hudson.model.StringParameterValue","value":"origin/master"},{"name":"sha1","_class":"hudson.model.StringParameterValue","value":"origin/pr/78/merge"},{"name":"ghprbActualCommit","_class":"hudson.model.StringParameterValue","value":"d473f9c0f47640010417392815fc25e8f4344c25"},{"name":"ghprbActualCommitAuthor","_class":"hudson.model.StringParameterValue","value":"[John Luo]"},{"name":"ghprbActualCommitAuthorEmail","_class":"hudson.model.StringParameterValue","value":"john@iotechsys.com"},{"name":"ghprbAuthorRepoGitUrl","_class":"hudson.model.StringParameterValue","value":"https://github.com/jluous/edgex-docs.git"},{"name":"ghprbTriggerAuthor","_class":"hudson.model.StringParameterValue","value":""},{"name":"ghprbTriggerAuthorEmail","_class":"hudson.model.StringParameterValue","value":""},{"name":"ghprbTriggerAuthorLogin","_class":"hudson.model.StringParameterValue","value":""},{"name":"ghprbTriggerAuthorLoginMention","_class":"hudson.model.StringParameterValue","value":""},{"name":"ghprbPullId","_class":"hudson.model.StringParameterValue","value":"78"},{"name":"ghprbTargetBranch","_class":"hudson.model.StringParameterValue","value":"master"},{"name":"ghprbSourceBranch","_class":"hudson.model.StringParameterValue","value":"master"},{"name":"GIT_BRANCH","_class":"hudson.model.StringParameterValue","value":"master"},{"name":"ghprbPullAuthorEmail","_class":"hudson.model.StringParameterValue","value":""},{"name":"ghprbPullAuthorLogin","_class":"hudson.model.StringParameterValue","value":"jluous"},{"name":"ghprbPullAuthorLoginMention","_class":"hudson.model.StringParameterValue","value":"@jluous"},{"name":"ghprbPullDescription","_class":"hudson.model.StringParameterValue","value":"GitHub pull request #78 of commit d473f9c0f47640010417392815fc25e8f4344c25, no merge conflicts."},{"name":"ghprbPullTitle","_class":"hudson.model.StringParameterValue","value":"Add Default Port Table"},{"name":"ghprbPullLink","_class":"hudson.model.StringParameterValue","value":"https://github.com/edgexfoundry/edgex-docs/pull/78"},{"name":"ghprbPullLongDescription","_class":"hudson.model.StringParameterValue","value":"Add service default Port table.\r\n\r\nSigned-off-by: [John Luo] <john@iotechsys.com>"},{"name":"ghprbCommentBody","_class":"hudson.model.StringParameterValue","value":"null"},{"name":"ghprbGhRepository","_class":"hudson.model.StringParameterValue","value":"edgexfoundry/edgex-docs"},{"name":"ghprbCredentialsId","_class":"hudson.model.StringParameterValue","value":"edgex-jenkins-access-pat"}],"_class":"org.jenkinsci.plugins.ghprb.GhprbParametersAction"},{},{},{"scmName":"","lastBuiltRevision":{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","branch":[{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","name":"refs/remotes/origin/pr/78/merge"}]},"remoteUrls":["git@github.com:edgexfoundry/edgex-docs"],"_class":"hudson.plugins.git.util.BuildData","buildsByBranchName":{"detached":{"marked":{"SHA1":"65c5d24b2a3e976d5f2c843fbb802da466472513","branch":[{"SHA1":"65c5d24b2a3e976d5f2c843fbb802da466472513","name":"detached"}]},"buildResult":null,"_class":"hudson.plugins.git.util.Build","revision":{"SHA1":"65c5d24b2a3e976d5f2c843fbb802da466472513","branch":[{"SHA1":"65c5d24b2a3e976d5f2c843fbb802da466472513","name":"detached"}]},"buildNumber":78},"refs/remotes/origin/pr/78/merge":{"marked":{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","branch":[{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","name":"refs/remotes/origin/pr/78/merge"}]},"buildResult":null,"_class":"hudson.plugins.git.util.Build","revision":{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","branch":[{"SHA1":"1cfb1795a02aab7ebbc99a6925c65fd4e8a34d8e","name":"refs/remotes/origin/pr/78/merge"}]},"buildNumber":85},"refs/remotes/origin/pr/71/merge":{"marked":{"SHA1":"afcb0c53585425c6b14cd6abfe42d6f8753e988c","branch":[{"SHA1":"afcb0c53585425c6b14cd6abfe42d6f8753e988c","name":"refs/remotes/origin/pr/71/merge"}]},"buildResult":null,"_class":"hudson.plugins.git.util.Build","revision":{"SHA1":"afcb0c53585425c6b14cd6abfe42d6f8753e988c","branch":[{"SHA1":"afcb0c53585425c6b14cd6abfe42d6f8753e988c","name":"refs/remotes/origin/pr/71/merge"}]},"buildNumber":76},"refs/remotes/origin/pr/62/merge":{"marked":{"SHA1":"b7f581fcf1be1fdd14f7ec8716c5c26fe05873fc","branch":[{"SHA1":"b7f581fcf1be1fdd14f7ec8716c5c26fe05873fc","name":"refs/remotes/origin/pr/62/merge"}]},"buildResult":null,"_class":"hudson.plugins.git.util.Build","revision":{"SHA1":"b7f581fcf1be1fdd14f7ec8716c5c26fe05873fc","branch":[{"SHA1":"b7f581fcf1be1fdd14f7ec8716c5c26fe05873fc","name":"refs/remotes/origin/pr/62/merge"}]},"buildNumber":53}}},{"_class":"hudson.plugins.git.GitTagAction"},{},{},{},{"parameters":[],"_class":"hudson.model.ParametersAction"},{},{},{},{}],"number":85,"timestamp":1579147757248,"changeSet":{"kind":"git","_class":"hudson.plugins.git.GitChangeSetList","items":[]},"building":false,"displayName":"#85","id":"85","estimatedDuration":189722,"fullDisplayName":"edgex-docs-master-verify-docs #85","description":"","duration":149532,"_class":"hudson.model.FreeStyleBuild","artifacts":[],"culprits":[],"keepLog":false,"url":"https://jenkins.edgexfoundry.org/job/edgex-docs-master-verify-docs/85/","queueId":162799,"result":"SUCCESS"},"updated_on":1579147757.248,"backend_version":"0.15.1"}`
	jenkinsRaw3, _ := toJenkinsRaw(rawItem3String)
	enrichItem3String := `{"project_ts":1579147757248,"metadata__updated_on":"2020-01-16T04:09:17.248Z","metadata__timestamp":"2020-02-15T00:02:12.025811Z","offset":null,"origin":"https://jenkins.edgexfoundry.org","tag":"https://jenkins.edgexfoundry.org","uuid":"609b30e8ed96ac57cb55dc0a87934f2c20460c43","fullDisplayName":"edgex-docs-master-verify-docs #85","url":"https://jenkins.edgexfoundry.org/job/edgex-docs-master-verify-docs/85/","result":"SUCCESS","duration":149532,"builtOn":"prd-centos7-docker-4c-2g-14669","fullDisplayName_analyzed":"edgex-docs-master-verify-docs #85","build":85,"job_url":"https://jenkins.edgexfoundry.org/job/edgex-docs-master-verify-docs","job_name":"edgex-docs-master-verify-docs","job_build":"#85/85","build_date":"2020-01-16T09:39:17.248+05:30","duration_days":0.0017306944444444444,"category":"test","installer":"docs","scenario":null,"testproject":"edgex","pod":"master","loop":"verify","branch":"docs","grimoire_creation_date":"2020-01-16T09:39:17.248+05:30","is_jenkins_job":1,"repository_labels":null,"metadata__filter_raw":null,"metadata__gelk_version":"","metadata__gelk_backend_name":"","metadata__enriched_on":"2020-12-23T20:33:08.120800531+05:30"}`
	jenkinsEnrich3, _ := toJenkinsEnrich(enrichItem3String)
	tests := []struct {
		name    string
		fields  fields
		args    args
		want    *BuildsEnrich
		wantErr bool
	}{
		{
			name: "Test Case #1",
			fields:fields{
				DSName:                "jenkins",
				ElasticSearchProvider: nil,
				BackendVersion:        "0.0.1",
			},
			args:args{
				rawItem: jenkinsRaw1,
				project: "project1",
				now:     time.Time{},
			},
			want: &jenkinsEnrich1,
			wantErr: false,
		},
		{
			name: "Test Case #2",
			fields:fields{
				DSName:                "jenkins",
				ElasticSearchProvider: nil,
				BackendVersion:        "0.0.1",
			},
			args:args{
				rawItem: jenkinsRaw2,
				project: "project1",
				now:     time.Time{},
			},
			want: &jenkinsEnrich2,
			wantErr: false,
		},
		{
			name: "Test Case #3",
			fields:fields{
				DSName:                "jenkins",
				ElasticSearchProvider: nil,
				BackendVersion:        "0.0.1",
			},
			args:args{
				rawItem: jenkinsRaw3,
				project: "project1",
				now:     time.Time{},
			},
			want: &jenkinsEnrich3,
			wantErr: false,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			e := &Enricher{
				DSName:                tt.fields.DSName,
				ElasticSearchProvider: tt.fields.ElasticSearchProvider,
				BackendVersion:        tt.fields.BackendVersion,
			}
			got, err := e.EnrichItem(tt.args.rawItem, tt.args.project, tt.args.now)
			if (err != nil) != tt.wantErr {
				t.Errorf("EnrichItem() error = %v, wantErr %v", err, tt.wantErr)
				return
			}
			assert.NotEqual(t, got, nil)
			assert.Equal(t, tt.want.UUID, got.UUID)
			assert.Equal(t, tt.want.Build, got.Build)
			assert.Equal(t, tt.want.Result, got.Result)
			assert.Equal(t, tt.want.Tag, got.Tag)
			assert.Equal(t, tt.want.ProjectTS, got.ProjectTS)
		})
	}
}

func toJenkinsEnrich(b string) (BuildsEnrich, error) {
	expectedEnrich := BuildsEnrich{}
	err := jsoniter.Unmarshal([]byte(b), &expectedEnrich)
	return expectedEnrich, err
}
